<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Wyszukiwarka mieszka≈Ñ - Wroc≈Çaw</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .form-section {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-row {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"], select {
            padding: 5px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
        }
        input[type="submit"] {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        input[type="submit"]:hover {
            background-color: #2980b9;
        }
        .chart {
            margin: 20px 0;
            text-align: center;
        }
        .chart img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .wiki-box {
            background-color: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
        }
        .badge-yes {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            background: #d4edda;
            color: #155724;
            font-weight: 500;
        }
        .badge-no {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            background: #f8d7da;
            color: #721c24;
            font-weight: 500;
        }
        
        /* Klasy dla kart mieszka≈Ñ - NOWY KOMPAKTOWY DESIGN */
        .apartment-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .apartment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .apartment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
        }
        .apartment-price {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: -0.5px;
        }
        .similarity-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 8px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        /* Nowy grid layout dla zawarto≈õci */
        .apartment-content {
            padding: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .info-box-title {
            font-size: 10px;
            color: #667eea;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .info-box-content {
            font-size: 11px;
            color: #2c3e50;
            line-height: 1.5;
        }
        
        .info-box-highlight {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 2px;
        }
        
        .amenities-row {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .distance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .distance-item {
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 10px;
            text-align: center;
        }
        
        .distance-label {
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .distance-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .location-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 12px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üè† Wyszukiwarka mieszka≈Ñ na sprzeda≈º - Wroc≈Çaw</h1>

    <!-- Informacje o Wroc≈Çawiu z Wikipedii -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="wiki-box">
            <h3 style="margin-top: 0; color: #e67e22;">üìö O Wroc≈Çawiu (parsowane z Wikipedii)</h3>
            <p style="line-height: 1.6;">{{ city_stats.pl }}</p>
            <div style="margin-top: 15px;">
                <strong>üë• Populacja:</strong> {{ "{:,}".format(city_stats.population|int).replace(',', ' ') }}<br>
                <strong>üìè Powierzchnia:</strong> {{ city_stats.area }} km¬≤
            </div>
        </div>
        
        <div style="background-color: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #2e7d32;">üìä Statystyki rynku</h3>
            <div style="font-size: 13px; line-height: 1.8; margin-bottom: 15px;">
                <strong>üìà Ofert:</strong> {{ "{:,}".format(district_stats.total_count).replace(',', ' ') }}<br>
                <strong>üí∞ ≈ör. cena:</strong> {{ "{:,.0f}".format(district_stats.avg_price).replace(',', ' ') }} z≈Ç<br>
                <strong>üìè ≈ör. metra≈º:</strong> {{ "%.1f"|format(district_stats.avg_sqm) }} m¬≤<br>
                <strong>üíµ Cena/m¬≤:</strong> {{ "{:,.0f}".format(district_stats.avg_price_per_sqm).replace(',', ' ') }} z≈Ç
            </div>
            
            <h4 style="margin: 10px 0 8px 0; color: #2e7d32; font-size: 14px;">‚ú® Ciekawostki</h4>
            <ul style="margin: 0; padding-left: 18px; font-size: 11px; line-height: 1.6;">
                {% for fact in city_stats.interesting_facts_pl %}
                <li style="margin-bottom: 4px;">{{ fact }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="form-section">
        <h2>Filtry mieszka≈Ñ</h2>
        <form method="POST">
            <div class="form-row">
                <label>Min. liczba pokoi:</label>
                <input type="number" name="min_rooms" min="1" step="1" 
                       value="{{ filters.get('min_rooms', '') }}">
            </div>
            
            <div class="form-row">
                <label>Metra≈º od (m¬≤):</label>
                <input type="number" name="min_square" value="{{ filters.get('min_square', '') }}">
                <label style="width: 50px; margin-left: 10px;">do:</label>
                <input type="number" name="max_square" value="{{ filters.get('max_square', '') }}">
            </div>
            
            <div class="form-row">
                <label>Cena od (z≈Ç):</label>
                <input type="number" name="min_price" value="{{ filters.get('min_price', '') }}">
                <label style="width: 50px; margin-left: 10px;">do:</label>
                <input type="number" name="max_price" value="{{ filters.get('max_price', '') }}">
            </div>
            
            <div class="form-row">
                <label>Min. piƒôtro:</label>
                <input type="number" name="min_floor" value="{{ filters.get('min_floor', '') }}">
            </div>
            
            <div class="form-row">
                <label>Max. piƒôter w budynku:</label>
                <input type="number" name="max_floor_count" value="{{ filters.get('max_floor_count', '') }}">
            </div>
            
            <div class="form-row">
                <label>Rok budowy od:</label>
                <input type="number" name="min_build_year" 
                       value="{{ filters.get('min_build_year', '') }}">
            </div>
            
            <div class="form-row">
                <label>Max km do centrum:</label>
                <input type="number" name="max_centre_distance" step="0.5"
                       value="{{ filters.get('max_centre_distance', '') }}">
            </div>
            <div class="form-row">
                <label>Balkon:</label>
                <select name="balcony">
                    <option value="">Dowolne</option>
                    <option value="yes" {% if filters.get('balcony')=='yes' %}selected{% endif %}>Tak</option>
                </select>
            </div>
            
            <div class="form-row">
                <label>Winda:</label>
                <select name="elevator">
                    <option value="">Dowolne</option>
                    <option value="yes" {% if filters.get('elevator')=='yes' %}selected{% endif %}>Tak</option>
                </select>
            </div>
            
            <div class="form-row">
                <label>Parking:</label>
                <select name="parking">
                    <option value="">Dowolne</option>
                    <option value="yes" {% if filters.get('parking')=='yes' %}selected{% endif %}>Tak</option>
                </select>
            </div>
            
            <div class="form-row">
                <label>Dzielnica/Osiedle:</label>
                <select name="district">
                    <option value="">Wszystkie</option>
                    {% for district in all_districts %}
                    <option value="{{ district }}" {% if filters.get('district')==district %}selected{% endif %}>{{ district }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row">
                <label>Sortuj wed≈Çug:</label>
                <select name="sort_by">
                    <option value="">Brak</option>
                    <option value="rooms" {% if sort_by=='rooms' %}selected{% endif %}>Pokoje</option>
                    <option value="squareMeters" {% if sort_by=='squareMeters' %}selected{% endif %}>Metra≈º</option>
                    <option value="floor" {% if sort_by=='floor' %}selected{% endif %}>Piƒôtro</option>
                    <option value="floorCount" {% if sort_by=='floorCount' %}selected{% endif %}>Liczba piƒôter</option>
                    <option value="price" {% if sort_by=='price' %}selected{% endif %}>Cena</option>
                </select>
            </div>
            
            <input type="submit" value="Zastosuj filtry">
        </form>
    </div>

    <div class="form-section" id="search-section">
        <h2>Wyszukiwanie po s≈Çowach kluczowych (TF-IDF)</h2>
        <form method="POST" id="search-form">
            <div class="form-row">
                <label>S≈Çowa kluczowe:</label>
                <input type="text" name="search" placeholder="np. tanie balkon parking" 
                    value="{{ search_query }}" style="width: 300px;">
                <input type="submit" value="Szukaj">
            </div>
            {% if search_query %}
            <input type="hidden" name="search" value="{{ search_query }}">
            <div class="form-row">
                <label>Sortuj wyniki po podobie≈Ñstwie:</label>
                <select name="similarity_sort" id="similarity-select">
                    <option value="" {% if not similarity_sort %}selected{% endif %}>Domy≈õlnie (TF-IDF)</option>
                    <option value="cosine" {% if similarity_sort == 'cosine' %}selected{% endif %}>Cosine</option>
                    <option value="jaccard" {% if similarity_sort == 'jaccard' %}selected{% endif %}>Jaccard</option>
                    <option value="dice" {% if similarity_sort == 'dice' %}selected{% endif %}>Dice</option>
                </select>
            </div>
            {% endif %}
        </form>
    </div>

{% if results %}
<h2>Wyniki wyszukiwania ({{ results|length }} mieszka≈Ñ)</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
    {% for result in results %}
    <div class="apartment-card">
    
        <!-- HEADER Z CENƒÑ -->
        <div class="apartment-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 16px; font-weight: bold; opacity: 0.9;">#{{ loop.index }}</span>
                <span class="apartment-price">{{ "{:,}".format(result["price"]|int).replace(',', ' ') }} z≈Ç</span>
            </div>
            
            {% if search_query %}
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                <div class="similarity-badge">
                    <div style="font-size: 9px; opacity: 0.8; margin-bottom: 2px;">Cosine</div>
                    <div style="font-size: 14px; font-weight: bold;">{{ "%.3f"|format(result.cosine_sim|default(0)) }}</div>
                </div>
                <div class="similarity-badge">
                    <div style="font-size: 9px; opacity: 0.8; margin-bottom: 2px;">Jaccard</div>
                    <div style="font-size: 14px; font-weight: bold;">{{ "%.3f"|format(result.jaccard_sim|default(0)) }}</div>
                </div>
                <div class="similarity-badge">
                    <div style="font-size: 9px; opacity: 0.8; margin-bottom: 2px;">Dice</div>
                    <div style="font-size: 14px; font-weight: bold;">{{ "%.3f"|format(result.dice_sim|default(0)) }}</div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- ZAWARTO≈öƒÜ - NOWY KOMPAKTOWY LAYOUT -->
        <div class="apartment-content">
            
            <!-- LOKALIZACJA -->
            {% if result.get("district_name") %}
            <div class="location-badge">
                üìç {{ result["district_name"] }}
            </div>
            {% endif %}
            
            <!-- G≈Å√ìWNE INFO - 3 KOLUMNY -->
            <div class="info-grid">
                <div class="info-box">
                    <div class="info-box-title">üè† Pokoje & Metra≈º</div>
                    <div class="info-box-content">
                        <div class="info-box-highlight">{{ result["rooms"]|int }} pok.</div>
                        <div>{{ "%.0f"|format(result["squareMeters"]) }} m¬≤</div>
                        <div style="font-size: 10px; color: #6c757d; margin-top: 2px;">
                            {{ "{:,.0f}".format(result["price"] / result["squareMeters"]).replace(',', ' ') }} z≈Ç/m¬≤
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-box-title">üè¢ Piƒôtro</div>
                    <div class="info-box-content">
                        <div class="info-box-highlight">{{ result["floor"]|int }}/{{ result["floorCount"]|int }}</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            {% if result["floor"]|int == 0 %}Parter{% elif result["floor"]|int == result["floorCount"]|int %}Ostatnie{% else %} {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-box-title">üìÖ Rok budowy</div>
                    <div class="info-box-content">
                        <div class="info-box-highlight">{{ result["buildYear"]|int if result["buildYear"] else "?" }}</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            {% if result["buildYear"] and result["buildYear"]|int >= 2010 %}Nowe{% elif result["buildYear"] and result["buildYear"]|int >= 1990 %}≈örednie{% else %}Starsze{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SZCZEG√ì≈ÅY BUDYNKU -->
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                <div style="font-size: 10px; color: #667eea; font-weight: bold; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                    üèóÔ∏è Budynek
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: #2c3e50;">
                    <div>
                        <strong>Typ:</strong> {{ {'blockOfFlats': 'Blok', 'apartmentBuilding': 'Apartamentowiec', 'tenement': 'Kamienica'}.get(result["type"], 'Brak danych') }}
                    </div>
                    <div>
                        <strong>Materia≈Ç:</strong> {{ {'brick': 'Ceg≈Ça', 'concreteSlab': 'P≈Çyta'}.get(result["buildingMaterial"], 'Brak danych') }}
                    </div>
                    <div>
                        <strong>W≈Çasno≈õƒá:</strong> {{ {'condominium': 'W≈Çasno≈õciowe', 'cooperative': 'Sp√≥≈Çdzielcze'}.get(result["ownership"], 'Brak danych') }}
                    </div>
                    <div>
                        <strong>Stan:</strong> {{ {'premium': 'Premium', 'low': 'Do remontu'}.get(result["condition"], 'Brak danych') }}
                    </div>
                </div>
            </div>
            
            <!-- UDOGODNIENIA -->
            <div style="margin-bottom: 12px;">
                <div style="font-size: 10px; color: #667eea; font-weight: bold; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                    ‚ú® Udogodnienia
                </div>
                <div class="amenities-row">
                    <span class="{% if result['hasBalcony']=='yes' %}badge-yes{% else %}badge-no{% endif %}">
                        {% if result['hasBalcony']=='yes' %}‚úì{% else %}‚úó{% endif %} Balkon
                    </span>
                    <span class="{% if result['hasElevator']=='yes' %}badge-yes{% else %}badge-no{% endif %}">
                        {% if result['hasElevator']=='yes' %}‚úì{% else %}‚úó{% endif %} Winda
                    </span>
                    <span class="{% if result['hasParkingSpace']=='yes' %}badge-yes{% else %}badge-no{% endif %}">
                        {% if result['hasParkingSpace']=='yes' %}‚úì{% else %}‚úó{% endif %} Parking
                    </span>
                    <span class="{% if result['hasSecurity']=='yes' %}badge-yes{% else %}badge-no{% endif %}">
                        {% if result['hasSecurity']=='yes' %}‚úì{% else %}‚úó{% endif %} Ochrona
                    </span>
                    <span class="{% if result['hasStorageRoom']=='yes' %}badge-yes{% else %}badge-no{% endif %}">
                        {% if result['hasStorageRoom']=='yes' %}‚úì{% else %}‚úó{% endif %} Piwnica
                    </span>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <!-- ODLEG≈ÅO≈öCI -->
            <div>
                <div style="font-size: 10px; color: #667eea; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                    üìè Odleg≈Ço≈õci
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                        Centrum: {{ "%.1f"|format(result["centreDistance"]) }} km
                    </span>
                    <span style="background: #e9ecef; padding: 4px 8px; border-radius: 12px; font-size: 10px; color: #6c757d;">
                        POI: {{ result["poiCount"]|int if result["poiCount"] else 0 }}
                    </span>
                </div>
                
                <div class="distance-grid">
                    <div class="distance-item">
                        <div class="distance-label">üè´ Szko≈Ça</div>
                        <div class="distance-value">{{ "%.2f"|format(result["schoolDistance"]) }} km</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">üè• Klinika</div>
                        <div class="distance-value">{{ "%.2f"|format(result["clinicDistance"]) }} km</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">üßí Przedszkole</div>
                        <div class="distance-value">{{ "%.2f"|format(result["kindergartenDistance"]) }} km</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">üíä Apteka</div>
                        <div class="distance-value">{{ "%.2f"|format(result["pharmacyDistance"]) }} km</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">üçΩÔ∏è Restauracja</div>
                        <div class="distance-value">{{ "%.2f"|format(result["restaurantDistance"]) }} km</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">üéì Uczelnia</div>
                        <div class="distance-value">{{ "%.2f"|format(result["collegeDistance"]) }} km</div>
                    </div>
                </div>
            </div>
            
            <!-- DOCUMENT -->
            <details style="margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
                <summary style="cursor: pointer; font-weight: bold; color: #667eea; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                    üìù Document tekstowy
                </summary>
                <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px; font-size: 9px; color: #666; line-height: 1.4; font-family: 'Courier New', monospace; max-height: 100px; overflow-y: auto;">
                    {{ result["document"] }}
                </div>
            </details>
        </div>
    </div>
{% endfor %}
</div>

{% if map_html %}
<h2 style="margin-top: 40px;">üó∫Ô∏è Mapa mieszka≈Ñ</h2>
{{ map_html|safe }}
{% endif %}

{% if charts %}
<h2 style="margin-top: 40px;">üìà Statystyki</h2>

<div class="chart">
    <h3>Rozk≈Çad cen</h3>
    <img src="data:image/png;base64,{{ charts.price_hist }}" alt="Histogram cen">
</div>

<div class="chart">
    <h3>Metra≈º vs Cena</h3>
    <img src="data:image/png;base64,{{ charts.scatter }}" alt="Scatter plot">
</div>

<div class="chart">
    <h3>Liczba pokoi</h3>
    <img src="data:image/png;base64,{{ charts.rooms_bar }}" alt="Bar chart pokoi">
</div>
{% endif %}

{% else %}
<p style="color: #7f8c8d; font-style: italic;">U≈ºyj wyszukiwania lub filtr√≥w, aby zobaczyƒá wyniki.</p>
{% endif %}

</div>


<script>
// Zapamiƒôtywanie pozycji scrolla przy ka≈ºdym submicie formularza
document.addEventListener('DOMContentLoaded', function() {
    // Przywr√≥ƒá pozycjƒô scrolla je≈õli by≈Ça zapisana
    const savedScroll = sessionStorage.getItem('scrollPosition');
    if (savedScroll) {
        window.scrollTo(0, parseInt(savedScroll));
        sessionStorage.removeItem('scrollPosition');
    }
    
    // Dla wszystkich formularzy
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            sessionStorage.setItem('scrollPosition', window.pageYOffset);
        });
    });
    
    // Dla selecta sortowania podobie≈Ñstwa (auto-submit)
    const similaritySelect = document.getElementById('similarity-select');
    if (similaritySelect) {
        similaritySelect.addEventListener('change', function() {
            sessionStorage.setItem('scrollPosition', window.pageYOffset);
            this.form.submit();
        });
    }
});
</script>

</body>
</html>